# Snowpark Container Services Specification Template
# This file is a template - actual deployment uses deploy_container.sh
# which generates the spec with correct values from default.config/custom.config
#
# Image paths will be: /${DATABASE_NAME}/${SCHEMA_NAME}/${REPOSITORY_NAME}/${IMAGE_NAME}:${TAG}
# Example: /BORDEREAU_PROCESSING_PIPELINE/PUBLIC/BORDEREAU_REPOSITORY/BORDEREAU_BACKEND:latest

spec:
  containers:
  # Backend container (internal only, no public endpoint)
  - name: backend
    image: /<DATABASE_NAME>/<SCHEMA_NAME>/<REPOSITORY_NAME>/<BACKEND_IMAGE_NAME>:latest
    env:
      ENVIRONMENT: production
      SNOWFLAKE_ROLE: SYSADMIN
      SNOWFLAKE_WAREHOUSE: COMPUTE_WH
      DATABASE_NAME: <DATABASE_NAME>
      BRONZE_SCHEMA_NAME: BRONZE
      SILVER_SCHEMA_NAME: SILVER
    resources:
      requests:
        cpu: 0.6
        memory: 2Gi
      limits:
        cpu: "2"
        memory: 4Gi
    startupProbe:
      port: 8000
      path: /api/health
      initialDelaySeconds: 10    # Wait 10s before first startup check
      periodSeconds: 5            # Check every 5 seconds
      timeoutSeconds: 3           # Timeout after 3 seconds
      successThreshold: 1         # 1 success = started
      failureThreshold: 12        # 12 failures = failed to start (60s total)
    readinessProbe:
      port: 8000
      path: /api/health
      initialDelaySeconds: 5     # After startup, wait 5s before readiness checks
      periodSeconds: 10           # Check every 10 seconds
      timeoutSeconds: 5           # Timeout after 5 seconds
      successThreshold: 1         # 1 successful probe = ready
      failureThreshold: 3         # 3 failed probes = not ready (30s total)
  
  # Frontend container (public endpoint, proxies to backend)
  - name: frontend
    image: /<DATABASE_NAME>/<SCHEMA_NAME>/<REPOSITORY_NAME>/<FRONTEND_IMAGE_NAME>:latest
    env:
      NGINX_WORKER_PROCESSES: "2"
    resources:
      requests:
        cpu: 0.4
        memory: 1Gi
      limits:
        cpu: 1
        memory: 2Gi
    readinessProbe:
      port: 80
      path: /

  # Only frontend is publicly accessible
  endpoints:
  - name: app
    port: 80
    public: true

# Enable caller's rights - service executes with caller's permissions
capabilities:
  securityContext:
    executeAsCaller: true
